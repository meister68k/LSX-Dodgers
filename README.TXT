・LSX-Dodgersをlinuxでビルド && z88dk向けに改造する
2021-02-15 ver1.24 by Meister


●概要

 本フォークはX1用の名作OS、LSX-Dodgers(※1)のソースをlinux環境でクロスビルド
できるように整備し、さらにz88dk(※2)でコンパイルしたプログラムが動作するよう
小改造を施したものです。
 LSX-Dodgersのオリジナルソースに含まれるOHM-Z80(※3)独自マクロを展開し、
Z80アセンブラのPasmo(※4)でアセンブルできるよう改変してあります。

※1 https://tablacus.github.io/LSX-Dodgers/
    https://github.com/tablacus/LSX-Dodgers
※2 Z80向けのクロスCコンパイラ
    https://z88dk.org/site/
※3 S-OS上でのみ動作する超多機能マクロアブソリュートアセンブラ
    Oh!X誌,1990年3月号,p.130～p.160 に掲載
    http://www.retropc.net/ohishi/s-os/ から入手可能
※4 easy to use Z80 cross-assembler, https://pasmo.speccy.org/
    Ubuntuなら apt install pasmo でインストールできる


●主な改変内容

Pasmo対応(1～7)
1. EX DE,IY を PUSH DE : EX (SP),IY : POP DE に展開
2. 擬似命令($INCLUDE、$CHAIN)の置き換え
3. ラベル名に使用できない文字([]!)を_に置換
4. 文字定数"A"を'A'に
5. 非ASCII文字(半角の・)をマクロ(BLTMARK)で指定
6. ソースフォルダ構成の変更
7. makefile追加
z88dk対応
8. プログラム起動時のSPをTPA末尾に変更
9. バージョン番号をver1.24とした。勝手にバージョン番号を変えるのも
   気が引けるが、オリジナルとの区別のためやむなく。


●トランジェントコマンド起動時のSPについて

 LSX-Dodgers ver1.23ではユーザプログラム起動時のSPがOSのスタック領域である
$0000となっていましたが、CP/MやMSX-DOSではTPA(ユーザプログラムの領域)末尾に
設定されているようです。
 この違いによりz88dkでビルドしたプログラムが動作しなかったためMSX-DOS同様の
SP位置に変更しました。


●よくわかっていない点

 オリジナルバイナリの先頭7バイト(fe 00 c6 e0 ed 00 c6)の意味がわかっていません。
(8バイト目からが$c600～のイニシャル・プログラムになっている)
 とりあえず同じ7バイトをそのまま先頭に入れています。


以下、オリジナルのREADME.TXT
----------------------------------------------------------------------

・LSX-Dodgers for X1/turbo version 1.23
・by Gaku

A>■


●機能概略

 このソフトはX1/turbo/ZでCP/M80やMSX-DOSのソフトを実行するためのOSです。
MS-DOS互換のファイルフォーマットを持ちCP/M80やMSX-DOSと互換のシステム・コールを持っています。
また、階層ディレクトリにも対応しています。


●各種X1エミュレータ用LSX-Dodgers 起動ディスクイメージ

https://tablacus.github.io/LSX-Dodgers/


●無保証

 このソフトは正しく動作することを望んで制作していますが、その動作については一切
保証されません。このソフトを使用したり、使用できなかった為に起こったいかなる損害に
ついても作者及び配布者は責任を負いません。個人の責任において使用して下さい。

●アセンブラ
LSX-Dodgersは超多機能マクロアブソリュートアセンブラOHM-Z80を使用しています。


●ライセンス

MIT License

●注意

 LSX-Dodgersはディスク・アクセスで簡単な遅廷書き込み機能を採用しています。カーソルが表示さ
れるキー待ちでバッファをフラッシュします。フロッピーの入れ換えは必ずカーソルが表示されている時に
行なって下さい。そうしないとディスクの内容を壊してしまうことがあります。
!特にディスク・エラーで処理を選択する時にはディスクの入れ換えをしないで下さい。


●その他

 ステップレートの関係でCZ-800Fは使えません。
MS-DOS互換のファイル・フォーマットとS-OS"SWORD"のファンクションをもつOS、L-os Angelesもよろしく


●History

1.00	1995. 7.24
新規作成

1.01	1995. 7.26
ファイルのクローズ($10)でオープンモードをクリアしていなかったバグをfix
ファイルの作成($16)でカレント&ランダム・レコードをクリアしないようにした。

1.02	1995. 8. 2
シェルで小文字のドライブ名を受け付けなかったので受け付けるよ
うにした。内部コマンドLでルートを指定できなくなったバグをfix
内部コマンドTでバッファを増やした。割り込みルーチンのバグfix

1.04	1995. 9. 4
利用者番号の設定と読み出し($20)を簡易処理するようにした

1.10	1995.11.12
コンソール入出力をBIOS-ROMを使わず自前で処理
MSX-DOSのランダム・ブロック・アクセスのサブセットをサポート
論理セクタを用いた読み書きをサポート。このためDPBが変わった。
システムコール時にスタックを別に確保するようにした
外部コマンドのサーチパスにサブディレクトリを指定できる様にした
バッチファイルで仮パラメータ(%1~%8)を扱える様にした。
起動時にAUTOEXEC.BAT,AUTOEXEC.COMを実行するようにした
ファイル末尾への追加でバッファの充填を抑制するようにした。
ディスク・バッファのフラッシュの改良。テンプレートのCAをサポート
内部コマンドM,T,Vがなくなった。
2HSのオーバー・トラックをサポート
ノンターボのX1で動作するようにした。

1.11	1996. 2.11
内部コマンドをMS-DOS風にした。内部コマンドTYPE復活
X1turboでは漢字を表示できるようになった。2HSをよりサポート
リダイレクト書き込みをサポート。エスケープ・シーケンスをサポート
デバイスをファイルとして扱えるようにした。(CON,AUX,PRN,NUL)
プリンタ(ANKのみ)のサポート。外部入出力にRS-232Cをサポート
シェルは情報を10進数で表示するようにした。
ファイル名の変更($17)で違うファイルをリネームする事があるバグをfix
ファイルの検索($11,$12)で検索したファイルをファイルのオープン($0F)、
ファイルの削除($13)、ファイルの作成($16)、ファイル名の変更($17)で
使う場合、速くなるようにした。
ディスク・エラーのIgnore(無視)の処理を少し安全にした。無視の
処理としては甘くなったかも…
フロッピーディスク・ドライバのシーク周りを変更
通過パスを指定できる様にした
キーリピートの開始時間を変更できるようにした

1.12	1996. 4.14
IBM系のフロッピーフォーマットをサポート
ノンターボでデバイス・エラーの処理のバグをfix
同じドライブの別のパスを指定できるようにした。
ソフトウェア・リセットを[CTRL]+[GRAPH]+[DEL]に変更した。
システムコールにファイル名の解析($29)を追加した。

1.20	1996. 6.14
v1.12で「..」(親ディレクトリ)を指定した場合、親ディレクトリがルート・
ディレクトリの場合、親ディレクトリに戻らなくなったエンバグをfix
上の処理の都合でFCBのアクセスするディレクトリのクラスタ番号の仕様変更
外部コマンドとバッチファイルを一緒に検索するようにした。
拡張子が.CPMの外部コマンドも実行できるようにした。
拡張子で(.COM,CPM,BAT)を指定した場合、指定した拡張子の
コマンド(バッチファイル)を実行するようにした。
ファイル・サイズの獲得($23)でDEレジスタに設定するFCBをオープンされた
FCBからオープンされていないFCBに変更した
MSX-DOS2に合わせてFCBの属性を+28から+13に変更した。
RS232C(AUX)のフロー制御をソフトフロー(Xon/Xoff)から
ハードフロー(RTS/CTS)に変更した
CP/M互換のファイル・アクセスはシステム・コール内部でランダム・ブロック・アクセスを
呼び出して実行するようにした。

1.21	1996. 8.12
リモート・リンクに対応していない部分を直した。
ブートとコンソール関係のみCP/M互換のBIOSコールを用意した。
システムのメモリ不足の都合でFCBのレコードサイズは指定しなくても1バイト
として扱うようにした。
CP/M用のコマンドでデフォルトのFCBとデフォルトのDTAを使用している
コマンドではv1.20ではファイル読み込みの際に先頭の1バイトが化ける
というエンバグの為、FCBのランダム・レコードを4バイトからCP/Mに合
わせた3バイトに変更した。
G-RAMディスクでパラメータによってエラーがでるバグをfix
コピー等の際のファイルの同時アクセスで簡易安全機能をOS側に付けた。
内部コマンドCOPYでコピー元でワイルドカードを指定しコピー先を同一ドライ
ブの別ディレクトリにした場合2つ目のファイルでエラーになるバグをfix

1.22	1996.11.12
イニシャル時に「IM 2」を実行するようにした
外部コマンドやバッチファイルの拡張子が小文字でも実行で
きるようにした。
TYPE等でサブディレクトリでワイルドカードを使ったりした
ばあい検索されないはずの「.」や「..」が検索されていたの
を直した。
80文字以外の画面モードに対応した。[GRAPH]+[HTAB]でアナ
ログモードのON/OFFができるようになった。
FCBのオープンモードを+24から+28へ移動した。
リダイレクト機能がなくなった。

1.23	1997. 3.24
ノンターボでディスクエラーが出るとエラーメッセージが止
まらなくなるバグをfix
CP/M互換のBIOSコールのCONOUTで表示するレジスタが間違っ
ていたのを直した。
